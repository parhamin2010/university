jQuery(function(){var $=jQuery;var searchInput=$("#searchInput");var ajaxType="get",ajaxPage=1,callDelay=500;$(".search-btn").on("click",function(){bodyScroll(false);$(".search-box").addClass("opened");$('.search-box [type="search"]').focus();});$(".trend-searches").find(".keyword").on("click",function(){searchInput.val($(this).text());fesch(null);});$(".search-box__top--close").on("click",function(){bodyScroll(true);$(".search-box").removeClass("opened");});document.onkeyup=function(e){if(e.keyCode==27){bodyScroll(true);$(".search-box").removeClass("opened");}};searchInput.on("input propertychange",function(evt){if(window.event&&event.type=="propertychange"&&event.propertyName!="value"){return;}window.clearTimeout($(this).data("timeout"));jQuery(this).data("timeout",setTimeout(function(){fesch(null,search_api_object.magSearchApiUrl,search_api_object.magSearchUrl,ajaxType,ajaxPage,8,search_api_object.digikalaFileUrl,search_api_object.digikalaProductUrl,search_api_object.digikalaSearchApi,search_api_object.digikalaSearchUrl);},callDelay));});});function fesch(ajaxDataType,magSearchApiUrl,magSearchUrl,ajaxType,ajaxPage,ajaxPerPage,digikalaFileUrl,digikalaProductUrl,digikalaSearchApi,digikalaSearchUrl){magSearchApiUrl=(typeof magSearchApiUrl!="undefined"?magSearchApiUrl:search_api_object.magSearchApiUrl);magSearchUrl=(typeof magSearchUrl!="undefined"?magSearchUrl:search_api_object.magSearchUrl);ajaxType=(typeof ajaxType!="undefined"?ajaxType:"get");ajaxPage=(typeof ajaxPage!="undefined"?ajaxPage:1);ajaxPerPage=(typeof ajaxPerPage!="undefined"?ajaxPerPage:8);digikalaFileUrl=(typeof digikalaFileUrl!="undefined"?digikalaFileUrl:search_api_object.digikalaFileUrl);digikalaProductUrl=(typeof digikalaProductUrl!="undefined"?digikalaProductUrl:search_api_object.digikalaProductUrl);digikalaSearchApi=(typeof digikalaSearchApi!="undefined"?digikalaSearchApi:search_api_object.digikalaSearchApi);digikalaSearchUrl=(typeof digikalaSearchUrl!="undefined"?digikalaSearchUrl:search_api_object.digikalaSearchUrl);var searchInput=jQuery("#searchInput"),noResultEl=jQuery(".no-result:not(.inner)"),noResultElInner=jQuery(".no-result.inner"),searchResultEl=jQuery(".search-results"),trendSearchEl=jQuery(".trend-searches"),dkResultEl=jQuery(".dk-results"),magResultEl=jQuery(".mag-results");jQuery.ajax({url:magSearchApiUrl,type:ajaxType,data:{action:"es_search",q:searchInput.val(),type:ajaxDataType,page:ajaxPage,per_page:ajaxPerPage,},success:function(response){if(isNullEmptySpace(response.hits)&&isNullEmptySpace(response.suggest)){searchResultEl.hide();trendSearchEl.hide();noResultElInner.hide();noResultEl.show();}else{if(isNullEmptySpace(response.hits)&&!isNullEmptySpace(response.suggest)){noResultEl.hide();noResultElInner.show();trendSearchEl.hide();searchResultEl.show();dkResultEl.hide();magResultEl.hide();insertSearchAutocomplete(response,jQuery(".autocomplete"),searchInput);insertSearchSuggestion(response,jQuery(".suggestion"),searchInput);}else{noResultEl.hide();noResultElInner.hide();trendSearchEl.hide();searchResultEl.show();dkResultEl.show();magResultEl.show();insertSearchResults(response,jQuery(".results-list"));insertSearchAutocomplete(response,jQuery(".autocomplete"),searchInput);insertSearchSuggestion(response,jQuery(".suggestion"),searchInput);}}},error:function(){},complete:function(){jQuery(".mag-results .module-title__btn").attr("href",magSearchUrl+searchInput.val());jQuery.ajax({url:digikalaSearchApi,type:ajaxType,data:{q:searchInput.val(),pageSize:3},success:function(response){insertDigikalaSearch(response,jQuery(".dk-results__items"),digikalaProductUrl,digikalaFileUrl);},complete:function(){jQuery(".dk-results .module-title__btn").attr("href",digikalaSearchUrl+searchInput.val());}});}});}function isNullEmptySpace(str){if(typeof str=="undefined"){return true;}else{if(typeof str=="object"){return false;}else{return str===null||str.length==0||str.match(/^ *$/)!==null;}}}function textEllipsis(string,limit){return string.substring(0,limit)+(string.length>=limit?"...":"");}function insertSearchResults(response,searchItemsWrapper){var searchItem='<a href="#" class="item"> <span class="image-wrapper"> <img src="#" alt="" class="image-wrapper__img"> </span> <span class="detail-wrapper"> <span class="detail-wrapper__title"></span> <span class="detail-wrapper__time"> <i class="icon-clock-icon"></i> <span class="detail-wrapper__time--detail"></span> </span> </span> </a>';searchItemsWrapper.find(".item").remove();for(var i=0;i<Object.keys(response.hits).length;i++){var _item=jQuery(searchItem).clone();if(response.hits[i].post_type=="video"){_item.addClass("video");}else{if(response.hits[i].post_type=="podcast"){_item.addClass("podcast");}}_item.attr("href",response.hits[i].permalink).find(".image-wrapper__img").attr("src",response.hits[i].thumbnails?response.hits[i].thumbnails.thumbnail:"no-image.jpg");_item.find(".detail-wrapper__title").html(textEllipsis(response.hits[i].post_title,50));_item.find(".detail-wrapper__time--detail").text(response.hits[i].post_jdate);searchItemsWrapper.append(_item);}}function insertSearchAutocomplete(response,autocompleteWrapper,searchInput){autocompleteWrapper.empty();if(typeof response.auto_complete=="undefined"||response.auto_complete==null){return;}var autocompleteItem=jQuery("<span>",{"class":"autocomplete__item"});for(var prop in response.auto_complete){for(var j=0;j<response.auto_complete[prop].length;j++){var _item=autocompleteItem.clone();_item.empty();var word=jQuery("<span>"+response.auto_complete[prop][j]+"</span>");var cat=jQuery('<span class="bold">'+typeRecognizer(prop)+"</span>");_item.attr("data-kind",prop).append(word).append("<span> در </span>").append(cat);_item.on("click",function(){searchInput.val(jQuery(this).find("span").first().text());fesch(jQuery(this).data("kind"));});autocompleteWrapper.append(_item);}}autocompleteWrapper.show();}function insertSearchSuggestion(response,suggestionWrapper,searchInput){suggestionWrapper.empty();if(typeof response.suggest=="undefined"||response.suggest==null){return;}var suggestTitle=jQuery('<span class="suggestion__title">آیا منظور شما این بود؟</span>');suggestionWrapper.append(suggestTitle);var suggestItem=jQuery("<span>",{"class":"autocomplete__item"});for(var i=0;i<response.suggest.length;i++){var _item=suggestItem.clone();_item.empty();var word=jQuery('<span class="suggestion__item">'+response.suggest[i]+"</span>");_item.attr("data-val",response.suggest[i]).append(word);_item.on("click",function(){searchInput.val(jQuery(this).data("val"));fesch(null);});suggestionWrapper.append(_item);}suggestionWrapper.show();}function insertDigikalaSearch(response,dkResultsWrapper,digikalaProductUrl,digikalaFileUrl){var results=response.hits.hits;var digikalaResultItem=jQuery("<a>",{"class":"item"});dkResultsWrapper.empty();for(var i=0;i<results.length;i++){var _item=digikalaResultItem.clone();_item.attr("href",digikalaProductUrl+results[i]._id);var image=jQuery("<img>",{"class":"item__img"}).attr("src",digikalaFileUrl+results[i]._source.ImagePath.replace("Original","70"));var title=jQuery("<span>",{"class":"item__title"}).text(results[i]._source.FaTitle||results[i]._source.Title);_item.append(image).append(title);dkResultsWrapper.append(_item);}}function typeRecognizer(type){var obj={post:"پستها",video:"ویدئوها",podcast:"پادکستها"};return obj[type];}